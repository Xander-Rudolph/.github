name: Run Ghost, generate static content, and publish to github pages

on:
  workflow_call:
    inputs:
      github-user:
        description: "github user name"
        required: true # once I nail down repo create this can use the actor and be set to false
        type: string
      dockerimage:
        description: "ghost docker image used to generate content"
        default: 'ghost:alpine'
        required: false
        type: string        
      content-path:
        description: "ghost docker image used to generate content"
        default: "${{ github.workspace }}/content"
        required: false
        type: string        
    secrets:
      OVERRIDE_TOKEN:
        required: false

env:
  github-user: ${{ inputs.github-user || github.actor }}
  github-repo: ${{ inputs.github-user || github.repository_owner }}.github.io
  GITHUB_OVERRIDE_TOKEN: ${{ secrets.OVERRIDE_TOKEN }}

jobs:
  repo:
    concurrency: ci-${{ github.ref }}
    runs-on: ubuntu-latest
    steps:
      - name: Create Repo 🔨
        uses: moutansos/create-repository-action@main
        with:
          name: ${{ env.github-repo }}
          org: ${{ inputs.github-user || github.repository_owner }}
          access-token: ${{ env.GITHUB_OVERRIDE_TOKEN }}
          private-repo: false
          initialize-repo: true

  ghost:
    concurrency: ci-${{ github.ref }}
    needs: repo
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v4
      
      - name: Run Ghost 👻
        run: docker run -d -p 2368:2368 -e NODE_ENV=development -e database__connection__filename='/var/lib/ghost/content/data/ghost.db' -v ${{ inputs.content-path }}:/var/lib/ghost/content ${{ inputs.dockerimage }}
      
      - name: Sleep for 10 seconds 💤
        uses: jakejarvis/wait-action@master
        with:
          time: "10s"
          
      - name: Install ghost-static-site-generator ✨
        run: npm install -g ghost-static-site-generator

      - name: Generate Static Site 🛠️
        run: gssg --url https://${{ env.github-repo }}

      - name: Deploy to Github Pages 🚀
        if: ${{ env.GITHUB_OVERRIDE_TOKEN != '' }}
        uses: JamesIves/github-pages-deploy-action@v4.6.4
        with:
          branch: main #gh-pages
          folder: static
          token: ${{ env.GITHUB_OVERRIDE_TOKEN }}
          repository-name: ${{ env.github-user }}/${{ env.github-repo }}
